blueprint:
  name: TUYA â€“ DÃ©tection humaine (event â†’ camÃ©ra auto, snapshot + notif critique)
  description: >
    Associe automatiquement un event.* Ã  une camÃ©ra en se basant sur le nom.
    Envoie une notification critique Companion App avec snapshot et accÃ¨s au flux.
  domain: automation

  input:
    cameras:
      name: CamÃ©ras Ã  surveiller
      selector:
        entity:
          domain: camera
          multiple: true

    notify_devices:
      name: Appareils Companion Ã  notifier
      selector:
        device:
          integration: mobile_app
          multiple: true

    notification_title:
      name: Titre notification
      default: "ðŸ“· DÃ©tection humaine"

    notification_message:
      name: Message notification
      default: "PrÃ©sence dÃ©tectÃ©e par la camÃ©ra"

    snapshot_path:
      name: Dossier snapshot
      default: "/media/cameras"

mode: parallel
max: 10

trigger:
  - platform: event
    event_type: state_changed

# ðŸ”‘ VARIABLES (OBLIGATOIRE POUR LES INPUTS)
variables:
  cameras: !input cameras
  snapshot_path: !input snapshot_path

condition:
  - condition: template
    value_template: >
      {% set entity = trigger.event.data.entity_id %}
      {% if not entity.startswith('event.') %}
        false
      {% else %}
        {% for cam in cameras %}
          {% set cam_name = cam.split('.')[-1] %}
          {% if cam_name in entity %}
            true
          {% endif %}
        {% endfor %}
        false
      {% endif %}

variables:
  camera_entity: >
    {% set entity = trigger.event.data.entity_id %}
    {% for cam in cameras %}
      {% set cam_name = cam.split('.')[-1] %}
      {% if cam_name in entity %}
        {{ cam }}
      {% endif %}
    {% endfor %}

  snapshot_file: >
    {{ snapshot_path }}/{{ camera_entity | replace('.', '_') }}.jpg

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: >
            notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}
          data:
            title: !input notification_title
            message: !input notification_message
            data:
              image: "{{ snapshot_file }}"
              clickAction: "/camera/{{ camera_entity }}"
              channel: tuya_critique
              importance: high
              priority: high
              ttl: 0