blueprint:
  name: TUYA ‚Äì D√©tection humaine (Corrig√©)
  description: >
    Envoie une notification lorsque les cam√©ras tuya d√©tectent un humain.
  domain: automation
  input:
    cameras:
      name: Cam√©ras √† surveiller
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils Companion √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true
    notification_title:
      name: Titre notification
      default: "üì∑ D√©tection humaine"
    notification_message:
      name: Message notification
      default: "Pr√©sence d√©tect√©e par la cam√©ra"
    snapshot_path:
      name: Dossier snapshot
      default: "/media/cameras/snapshots"

mode: parallel
max: 10

trigger:
  # On filtre pour ne d√©clencher que sur le domaine 'event' lors d'un changement d'√©tat r√©el
  - platform: state
    entity_id: []
    # On ne pr√©cise pas d'ID ici, mais on va filtrer dans la condition
    # pour ne pas surcharger le processeur.

variables:
  # On force la r√©cup√©ration des inputs en variables locales s√©curis√©es
  input_cameras: !input cameras
  input_snapshot_path: !input snapshot_path
  
  # Identification de l'entit√© qui a d√©clench√©
  trigger_entity: "{{ trigger.entity_id }}"
  
  # Logique de correspondance Cam√©ra <-> Event
  camera_entity: >
    {% set ns = namespace(found="") %}
    {% for cam in input_cameras %}
      {% set cam_name = cam.split('.')[-1] %}
      {# Si le nom de la cam√©ra est contenu dans l'ID de l'√©v√©nement #}
      {% if cam_name in trigger_entity %}
        {% set ns.found = cam %}
      {% endif %}
    {% endfor %}
    {{ ns.found }}

  snapshot_file: "{{ input_snapshot_path }}/{{ camera_entity | replace('.', '_') }}.jpg"

condition:
  # 1. L'entit√© doit appartenir au domaine 'event'
  - "{{ trigger.domain == 'event' }}"
  # 2. On v√©rifie qu'une cam√©ra correspondante a √©t√© trouv√©e
  - "{{ camera_entity != '' }}"
  # 3. On v√©rifie que l'√©tat n'est pas inconnu (√©vite les erreurs au reboot)
  - "{{ states(trigger_entity) not in ['unknown', 'unavailable'] }}"

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: !input notification_title
            message: !input notification_message
            data:
              image: "/media/local/cameras/snapshots/{{ camera_entity | replace('.', '_') }}.jpg"
              clickAction: "/camera/{{ camera_entity }}"
              channel: tuya_critique
              importance: high
              priority: high
