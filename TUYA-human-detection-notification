blueprint:
  name: TUYA – Détection personnalisée (snapshot + Live direct Android)
  description: >
    Notifie sur Android lors d'un événement Tuya (event.*) avec filtrage optionnel par cmd,
    prise d’un snapshot, et ouverture du direct caméra via entityId (sans Lovelace).
    Inclut un cooldown anti-spam.
  domain: automation

  input:
    event_entities:
      name: Entités d'événements Tuya (event.*)
      description: >
        Entités event.* générées par Tuya (ex: event.xxx_message).
      selector:
        entity:
          domain: event
          multiple: true

    camera_entities:
      name: Caméras associées (camera.*)
      description: >
        Correspondance automatique par sous-chaîne :
        si l’object_id de la caméra (après "camera.") est contenu dans l’object_id de l’événement (après "event."),
        elle est sélectionnée.
        Exemple : event.cam_entree_st_flo_doorbell_message -> camera.cam_entree_st_flo
        Si aucune correspondance, la première caméra de la liste est utilisée.
      selector:
        entity:
          domain: camera
          multiple: true

    event_types:
      name: Type(s) d'événement à détecter (cmd Tuya)
      description: >
        Liste CSV des cmd attendus (ex: ipc_bang, ipc_human, ipc_motion).
        Laisser vide pour déclencher sur tous les événements.
      default: ""
      selector:
        text:

    notify_devices:
      name: Appareils à notifier (Android / Companion App)
      description: >
        Sélectionne un ou plusieurs appareils enregistrés via l’intégration mobile_app.
        Le blueprint utilise ensuite notify.mobile_app_<device_id>.
      selector:
        device:
          integration: mobile_app
          multiple: true

    notif_title:
      name: Titre de la notification
      default: "Alerte caméra"
      selector:
        text:

    notif_message:
      name: Message
      description: >
        Variables disponibles :
          - {{ detected_cmd }}
          - {{ trigger_entity }}
          - {{ camera_entity }}
      default: "Événement {{ detected_cmd }} — {{ camera_entity or trigger_entity }}"
      selector:
        text:

    open_live_on_tap:
      name: Ouvrir le direct au tap sur la notification (Android)
      description: >
        Si activé, un tap sur la notification ouvre entityId:camera.xxx.
      default: true
      selector:
        boolean:

    show_live_button:
      name: Afficher un bouton "Voir la vidéo"
      description: >
        Ajoute un bouton qui ouvre entityId:camera.xxx.
      default: true
      selector:
        boolean:

    cooldown_seconds:
      name: Cooldown anti-spam (secondes)
      default: 5
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: s
          mode: slider

    snapshot_dir:
      name: Dossier de snapshots
      description: >
        Recommandé : /media/... (servi sous /media/local/... pour les notifications).
        Assure-toi que le dossier existe.
      default: "/media/camera/snapshot"
      selector:
        text:

mode: parallel
max: 10

trigger:
  - platform: state
    entity_id: !input event_entities

variables:
  trigger_entity: "{{ trigger.entity_id }}"

  # Lecture robuste du JSON Tuya dans l'attribut 'message'
  msg_raw: "{{ state_attr(trigger_entity, 'message') | default('{}') }}"
  msg_json: >
    {% set s = msg_raw | string %}
    {% if s.startswith('{') and s.endswith('}') %}
      {{ s | from_json }}
    {% else %}
      {{ dict() }}
    {% endif %}

  # cmd Tuya
  detected_cmd: >
    {{ msg_json.get('cmd')
       or state_attr(trigger_entity, 'cmd')
       or state_attr(trigger_entity, 'type')
       or state_attr(trigger_entity, 'event_type')
       or 'unknown' }}

  # Filtre cmd (CSV)
  wanted_csv: !input event_types
  wanted_list: >
    {% set csv = wanted_csv | default('') | trim %}
    {% if csv == '' %}
      {{ [] }}
    {% else %}
      {{ csv.split(',') | map('trim') | reject('equalto','') | list }}
    {% endif %}
  match_evt: "{{ (wanted_list | length == 0) or (detected_cmd in wanted_list) }}"

  # Correspondance caméra (sous-chaîne object_id)
  cameras: !input camera_entities
  camera_entity: >
    {% set evt_obj = trigger_entity.split('.')[-1] %}
    {% set found = namespace(val='') %}
    {% for cam in cameras %}
      {% set cam_obj = cam.split('.')[-1] %}
      {% if cam_obj in evt_obj %}
        {% set found.val = cam %}
      {% endif %}
    {% endfor %}
    {{ found.val if found.val else (cameras[0] if cameras|length>0 else '') }}

  # Snapshot : chemin disque + URL /media/local/
  ts: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
  snapshot_dir: !input snapshot_dir
  snapshot_path: >
    {{ snapshot_dir ~ '/'
       ~ (camera_entity|replace('.','_') if camera_entity else 'event')
       ~ '_' ~ ts ~ '.jpg' }}
  snapshot_url: "{{ snapshot_path | replace('/media/', '/media/local/') }}"

  # Cooldown
  cooldown: !input cooldown_seconds
  allow_notify: >
    {% set last = this.last_triggered if this is defined else none %}
    {% if cooldown | int == 0 %}
      true
    {% elif last is none %}
      true
    {% else %}
      {{ (as_timestamp(now()) - as_timestamp(last)) >= (cooldown | int) }}
    {% endif %}

  # Cible live (Android)
  open_live_on_tap: !input open_live_on_tap
  show_live_button: !input show_live_button
  live_target: "{{ 'entityId:' ~ camera_entity if camera_entity else '' }}"

condition:
  - condition: template
    value_template: "{{ match_evt }}"
  - condition: template
    value_template: "{{ allow_notify }}"
  - condition: template
    value_template: "{{ camera_entity != '' }}"

action:
  # 1) Snapshot
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_path }}"

  - delay: "00:00:01"

  # 2) Notifications (Android) via notify.mobile_app_<device_id>
  - choose:
      # Tap + bouton
      - conditions:
          - condition: template
            value_template: "{{ show_live_button and open_live_on_tap }}"
        sequence:
          - repeat:
              for_each: !input notify_devices
              sequence:
                - service: "notify.mobile_app_{{ repeat.item }}"
                  data:
                    title: !input notif_title
                    message: !input notif_message
                    data:
                      image: "{{ snapshot_url }}"
                      attachment:
                        url: "{{ snapshot_url }}"
                        content-type: jpeg
                        hide-thumbnail: false
                      clickAction: "{{ live_target }}"
                      actions:
                        - action: URI
                          title: "Voir la vidéo"
                          uri: "{{ live_target }}"

      # Tap uniquement
      - conditions:
          - condition: template
            value_template: "{{ (not show_live_button) and open_live_on_tap }}"
        sequence:
          - repeat:
              for_each: !input notify_devices
              sequence:
                - service: "notify.mobile_app_{{ repeat.item }}"
                  data:
                    title: !input notif_title
                    message: !input notif_message
                    data:
                      image: "{{ snapshot_url }}"
                      attachment:
                        url: "{{ snapshot_url }}"
                        content-type: jpeg
                        hide-thumbnail: false
                      clickAction: "{{ live_target }}"

      # Bouton uniquement
      - conditions:
          - condition: template
            value_template: "{{ show_live_button and (not open_live_on_tap) }}"
        sequence:
          - repeat:
              for_each: !input notify_devices
              sequence:
                - service: "notify.mobile_app_{{ repeat.item }}"
                  data:
                    title: !input notif_title
                    message: !input notif_message
                    data:
                      image: "{{ snapshot_url }}"
                      attachment:
                        url: "{{ snapshot_url }}"
                        content-type: jpeg
                        hide-thumbnail: false
                      actions:
                        - action: URI
                          title: "Voir la vidéo"
                          uri: "{{ live_target }}"

    # Aucun live : notification simple
    default:
      - repeat:
          for_each: !input notify_devices
          sequence:
            - service: "notify.mobile_app_{{ repeat.item }}"
              data:
                title: !input notif_title
                message: !input notif_message
                data:
                  image: "{{ snapshot_url }}"
                  attachment:
                    url: "{{ snapshot_url }}"
                    content-type: jpeg
                    hide-thumbnail: false
