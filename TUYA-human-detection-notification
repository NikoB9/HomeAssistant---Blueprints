blueprint:
  name: TUYA ‚Äì D√©tection humaine
  description: >
    Notifie les d√©tections d‚Äôhumains remont√©es par les cam√©ras tuya s√©lectionn√©es.
  domain: automation
  input:
    cameras:
      name: Cam√©ras √† surveiller
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils Companion √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true
    notification_title:
      name: Titre notification
      default: "üì∑ D√©tection humaine"
    notification_message:
      name: Message notification
      default: "Pr√©sence d√©tect√©e par la cam√©ra"
    snapshot_path:
      name: Dossier snapshot
      default: "/media/cameras/snapshots"

mode: parallel
max: 10

# 1. On limite le trigger au domaine 'event' pour √©viter de saturer le CPU
trigger:
  - platform: event
    event_type: state_changed

# 2. On d√©finit TOUTES les variables ici
variables:
  cameras: !input cameras
  snapshot_path: !input snapshot_path
  # On extrait l'entit√© qui a d√©clench√© pour l'utiliser plus bas
  trigger_entity: "{{ trigger.event.data.entity_id }}"
  # On cherche la cam√©ra correspondante d√®s maintenant
  camera_entity: >
    {% set found = ns(entity="") %}
    {% if trigger_entity.startswith('event.') %}
      {% for cam in cameras %}
        {% set cam_name = cam.split('.')[-1] %}
        {% if cam_name in trigger_entity %}
          {% set found.entity = cam %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {{ found.entity }}
  snapshot_file: "{{ snapshot_path }}/{{ camera_entity | replace('.', '_') }}.jpg"

# 3. La condition v√©rifie simplement si on a trouv√© une cam√©ra
condition:
  - condition: template
    value_template: "{{ camera_entity != '' }}"

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: !input notification_title
            message: !input notification_message
            data:
              image: "{{ snapshot_file }}"
              clickAction: "/camera/{{ camera_entity }}"
              channel: tuya_critique
              importance: high
              priority: high
              ttl: 0
