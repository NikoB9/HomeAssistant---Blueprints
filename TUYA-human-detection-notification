blueprint:
  name: TUYA ‚Äì D√©tection humaine (V2 Stable)
  description: >
    Associe un event.* √† une cam√©ra Tuya et envoie une notification.
  domain: automation
  input:
    cameras:
      name: Cam√©ras √† surveiller
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils Companion √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true
    notification_title:
      name: Titre notification
      default: "üì∑ D√©tection humaine"
    notification_message:
      name: Message notification
      default: "Pr√©sence d√©tect√©e par la cam√©ra"
    snapshot_path:
      name: Dossier snapshot
      default: "/media/cameras/snapshots"

mode: parallel
max: 10

# FILTRE : On ne d√©clenche QUE si une entit√© "event" change d'√©tat
trigger:
  - platform: state
    entity_id: [] # Laiss√© vide ici car on va filtrer par domaine ou via les variables
    # Note : HA ne permet pas de filtrer par domaine facilement dans le trigger d'un blueprint sans lister les entit√©s.
    # Pour stopper les erreurs, on utilise un trigger d'√©v√©nement brut mais filtr√©.
  - platform: event
    event_type: state_changed
    event_data:
      domain: event # On ne regarde QUE le domaine event

variables:
  cameras: !input cameras
  snapshot_path: !input snapshot_path
  # R√©cup√©ration s√©curis√©e de l'ID de l'entit√©
  trigger_entity: "{{ trigger.event.data.entity_id if trigger.event is defined else trigger.entity_id }}"
  
  # Recherche de la cam√©ra correspondante (Correction namespace)
  camera_entity: >
    {% set found = namespace(entity="") %}
    {% if trigger_entity is defined and trigger_entity.startswith('event.') %}
      {% for cam in cameras %}
        {% set cam_name = cam.split('.')[-1] %}
        {% if cam_name in trigger_entity %}
          {% set found.entity = cam %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {{ found.entity }}

  snapshot_file: "{{ snapshot_path }}/{{ camera_entity | replace('.', '_') }}.jpg"

condition:
  # On v√©rifie qu'on a bien trouv√© une cam√©ra et que l'√©v√©nement est bien une d√©tection (state != unknown)
  - condition: template
    value_template: "{{ camera_entity != '' and states(trigger_entity) not in ['unknown', 'unavailable'] }}"

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: !input notification_title
            message: !input notification_message
            data:
              image: "{{ snapshot_file }}"
              clickAction: "/camera/{{ camera_entity }}"
              channel: tuya_critique
              importance: high
              priority: high
              ttl: 0
