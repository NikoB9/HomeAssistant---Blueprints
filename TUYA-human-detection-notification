blueprint:
  name: TUYA ‚Äì D√©tection humaine (Lien Direct - Instantan√©)
  description: >
    Envoie une notification imm√©diate sans snapshot. Le clic ouvre le direct.
  domain: automation
  input:
    cameras:
      name: Cam√©ras √† surveiller
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils Companion √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true
    notification_title:
      name: Titre notification
      default: "üèÉ Mouvement d√©tect√©"
    notification_message:
      name: Message notification
      default: "Une pr√©sence humaine a √©t√© d√©tect√©e."

# Mode parall√®le pour traiter chaque √©v√©nement imm√©diatement
mode: parallel
max: 10

trigger:
  - platform: state
    entity_id: []

variables:
  input_cameras: !input cameras
  trigger_entity: "{{ trigger.entity_id }}"
  
  camera_entity: >
    {% set ns = namespace(found="") %}
    {% for cam in input_cameras %}
      {% set cam_name = cam.split('.')[-1] %}
      {% if cam_name in trigger_entity %}
        {% set ns.found = cam %}
      {% endif %}
    {% endfor %}
    {{ ns.found }}

condition:
  - "{{ trigger.domain == 'event' }}"
  - "{{ camera_entity != '' }}"
  - "{{ states(trigger_entity) not in ['unknown', 'unavailable'] }}"

action:
  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: !input notification_title
            message: "{{ notification_message }} (Cam√©ra: {{ state_attr(camera_entity, 'friendly_name') }})"
            data:
              clickAction: "/control_panel/{{ camera_entity }}"
              uri: "/entity-card/{{ camera_entity }}"
              channel: tuya_detection
              importance: high
              priority: high
