blueprint:
  name: TUYA ‚Äì D√©tection humaine (Analyse Message)
  description: >
    D√©clenche une notification lors d‚Äôune d√©tection de corps humain.
  domain: automation
  input:
    event_entities:
      name: Entit√©s "Event" √† surveiller
      description: S√©lectionnez les entit√©s qui finissent par '_doorbell_message' ou '_motion_video_analysis'.
      selector:
        entity:
          domain: event
          multiple: true
    camera_entities:
      name: Cam√©ras correspondantes
      description: Les entit√©s cam√©ras pour ouvrir le direct.
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true

mode: parallel
max: 10

trigger:
  - platform: state
    entity_id: !input event_entities

variables:
  # On r√©cup√®re le message JSON envoy√© par Tuya
  event_msg: "{{ trigger.to_state.attributes.message | default('') }}"
  # On v√©rifie si c'est une d√©tection humaine
  is_human: "{{ 'ipc_human' in event_msg }}"
  
  # Logique de correspondance pour trouver la cam√©ra
  all_cameras: !input camera_entities
  trigger_entity: "{{ trigger.entity_id }}"
  camera_entity: >
    {% set ns = namespace(found="") %}
    {% for cam in all_cameras %}
      {% set cam_name = cam.split('.')[-1] %}
      {% if cam_name in trigger_entity %}
        {% set ns.found = cam %}
      {% endif %}
    {% endfor %}
    {{ ns.found }}

condition:
  # 1. On ne continue QUE si le message contient 'ipc_human'
  - "{{ is_human }}"
  # 2. On v√©rifie qu'on a trouv√© une cam√©ra correspondante
  - "{{ camera_entity != '' }}"

action:
  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: "üèÉ Humain d√©tect√© !"
            message: "Pr√©sence d√©tect√©e sur {{ state_attr(camera_entity, 'friendly_name') }}"
            data:
              clickAction: "/control_panel/{{ camera_entity }}"
              uri: "/entity-card/{{ camera_entity }}"
              channel: tuya_detection
              importance: high
              priority: high
