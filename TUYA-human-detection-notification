blueprint:
  name: CamÃ©ra â€“ DÃ©tection humaine via event associÃ© (snapshot + notification critique)
  description: >
    Surveille les Ã©vÃ©nements liÃ©s Ã  une ou plusieurs camÃ©ras en se basant
    sur la similaritÃ© de nom entre lâ€™entitÃ© event.* et la camÃ©ra.
    Envoie une notification critique avec snapshot et accÃ¨s au flux vidÃ©o.
  domain: automation

  input:
    cameras:
      name: CamÃ©ras Ã  surveiller
      selector:
        entity:
          domain: camera
          multiple: true

    notify_devices:
      name: Appareils Ã  notifier
      selector:
        device:
          integration: mobile_app
          multiple: true

    notification_title:
      name: Titre
      default: "ðŸ“· DÃ©tection camÃ©ra"

    notification_message:
      name: Message
      default: "Une prÃ©sence a Ã©tÃ© dÃ©tectÃ©e"

    snapshot_path:
      name: Dossier snapshot
      default: "/media/cameras"

mode: parallel
max: 10

trigger:
  - platform: event
    event_type: state_changed

condition:
  - condition: template
    value_template: >
      {% set entity = trigger.event.data.entity_id %}
      {% if not entity.startswith('event.') %}
        false
      {% else %}
        {% set cam_ids = expand(cameras) | map(attribute='entity_id') | list %}
        {% for cam in cam_ids %}
          {% set cam_name = cam.split('.')[-1] %}
          {% if cam_name in entity %}
            true
          {% endif %}
        {% endfor %}
        false
      {% endif %}

variables:
  camera_entity: >
    {% set entity = trigger.event.data.entity_id %}
    {% set cam_ids = expand(cameras) | map(attribute='entity_id') | list %}
    {% for cam in cam_ids %}
      {% set cam_name = cam.split('.')[-1] %}
      {% if cam_name in entity %}
        {{ cam }}
      {% endif %}
    {% endfor %}

  snapshot_file: >
    {{ snapshot_path }}/{{ camera_entity | replace('.', '_') }}.jpg

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}
          data:
            title: !input notification_title
            message: !input notification_message
            data:
              image: "{{ snapshot_file }}"
              clickAction: "/lovelace/default_view"
              channel: tuya_critique
              importance: high
              priority: high
              ttl: 0