blueprint:
  name: TUYA ‚Äì D√©tection humaine (Correction)
  description: >
    D√©clenche une notification lors d‚Äôune d√©tection de corps humain.
  domain: automation
  input:
    event_entities:
      name: Entit√©s "Event" √† surveiller
      selector:
        entity:
          domain: event
          multiple: true
    camera_entities:
      name: Cam√©ras correspondantes
      selector:
        entity:
          domain: camera
          multiple: true
    notify_devices:
      name: Appareils √† notifier
      selector:
        device:
          integration: mobile_app
          multiple: true

# On d√©finit le mode UNE SEULE FOIS ici
mode: parallel
max: 10

trigger:
  - platform: state
    entity_id: !input event_entities

variables:
  # On s√©curise l'extraction du message
  trigger_id: "{{ trigger.entity_id | default('unknown') }}"
  # On transforme les attributs en texte pour une recherche infaillible
  all_attributes: "{{ trigger.to_state.attributes | string }}"
  is_human: "{{ 'ipc_human' in all_attributes }}"
  
  # Logique de correspondance pour trouver la cam√©ra
  all_cameras: !input camera_entities
  camera_entity: >
    {% set ns = namespace(found="") %}
    {% if trigger_id != 'unknown' %}
      {% for cam in all_cameras %}
        {% set cam_name = cam.split('.')[-1] %}
        {% if cam_name in trigger_id %}
          {% set ns.found = cam %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {{ ns.found }}

condition:
  # 1. On ne continue QUE si c'est un humain
  - "{{ is_human }}"
  # 2. On v√©rifie qu'on a trouv√© une cam√©ra correspondante
  - "{{ camera_entity != '' }}"

action:
  - repeat:
      for_each: !input notify_devices
      sequence:
        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
          data:
            title: "üèÉ Humain d√©tect√© !"
            message: "Pr√©sence d√©tect√©e sur {{ state_attr(camera_entity, 'friendly_name') | default('Cam√©ra') }}"
            data:
              clickAction: "/control_panel/{{ camera_entity }}"
              uri: "/entity-card/{{ camera_entity }}"
              channel: tuya_detection
              importance: high
              priority: high