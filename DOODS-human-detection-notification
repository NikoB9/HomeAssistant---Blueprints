blueprint:
  name: DOODS â€“ Multi-camÃ©ras â†’ 2 photos + 2 notifications (Companion)
  description: >
    Prend 2 snapshots et envoie 2 notifications push
    lorsqu'une entitÃ© DOODS dÃ©tecte un label (ex: person).

  domain: automation

  input:
    doods_entities:
      name: EntitÃ©s DOODS
      selector:
        entity:
          domain: image_processing
          multiple: true

    label_name:
      name: Label DOODS Ã  dÃ©tecter
      default: person
      selector:
        text:

    min_confidence:
      name: Confiance minimale (%)
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"

    notify_service:
      name: Service notify mobile
      selector:
        text:

    snapshot_dir:
      name: Dossier snapshots
      default: /config/www/snapshots/camera
      selector:
        text:

    second_between_photos:
      name: DÃ©lai entre les photos (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 1

mode: parallel
max: 10

###############################################################################
# VARIABLES Dâ€™ENTRÃ‰E
###############################################################################
variables:
  i_label: !input label_name
  i_conf: !input min_confidence
  i_notify: !input notify_service
  i_dir: !input snapshot_dir
  i_delay: !input second_between_photos

###############################################################################
# TRIGGER
# â†’ dÃ©clenche uniquement quand DOODS passe au-dessus de 0
###############################################################################
trigger:
  - platform: numeric_state
    entity_id: !input doods_entities
    above: 0

###############################################################################
# CONDITIONS
###############################################################################
condition:

  # VÃ©rifie quâ€™un objet DOODS correspond bien au label demandÃ©
  - condition: template
    alias: "Label DOODS prÃ©sent avec confiance suffisante"
    value_template: >
      {% set matches = state_attr(trigger.entity_id, 'matches') or [] %}
      {% set label = i_label | lower %}
      {% set conf = i_conf | float / 100 %}
      {{ matches
         | selectattr('label','equalto', label)
         | selectattr('score','>=', conf)
         | list
         | count > 0 }}

###############################################################################
# ACTIONS
###############################################################################
action:

  # Variables calculÃ©es dynamiquement Ã  partir de l'entitÃ© DOODS
  - variables:
      # image_processing.doods_camera_xxx â†’ camera.camera_xxx
      camera_entity: >
        {% set eid = trigger.entity_id.replace('image_processing.doods_', '') %}
        {{ 'camera.' ~ eid }}

      camera_name: "{{ camera_entity.split('camera.')[-1] }}"
      ts: "{{ now().strftime('%Y%m%d_%H%M%S') }}"

      file1: "{{ i_dir ~ '/' ~ camera_name ~ '_' ~ ts ~ '_1.jpg' }}"
      file2: "{{ i_dir ~ '/' ~ camera_name ~ '_' ~ ts ~ '_2.jpg' }}"

      url1: "{{ '/local' ~ file1.split('/config/www')[-1] }}"
      url2: "{{ '/local' ~ file2.split('/config/www')[-1] }}"

  # ğŸ“¸ Snapshot 1
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ file1 }}"

  # â±ï¸ Pause configurable
  - delay:
      seconds: "{{ i_delay }}"

  # ğŸ“¸ Snapshot 2
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ file2 }}"

  # ğŸ“² Notification 1
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ‘¤ Personne dÃ©tectÃ©e ({{ camera_name }})"
      message: "DÃ©tection DOODS â‰¥ {{ i_conf }}%"
      data:
        image: "{{ url1 }}"
        push:
          sound: default

  # ğŸ“² Notification 2
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ“¸ DeuxiÃ¨me photo ({{ camera_name }})"
      message: "Instant +{{ i_delay }}s"
      data:
        image: "{{ url2 }}"