blueprint:
  name: DOODS â€“ Multi-camÃ©ras â†’ 2 photos + 2 notifications (Companion)
  description: >
    Prend 2 snapshots et envoie 2 notifications push (avec images)
    lorsqu'une entitÃ© DOODS dÃ©tecte un label donnÃ© (ex: person).
    Compatible avec la structure DOODS :
    matches: { label: [ { score, box } ] }

  domain: automation

  input:
    doods_entities:
      name: EntitÃ©s DOODS
      description: >
        EntitÃ©s image_processing.doods_* Ã  surveiller
      selector:
        entity:
          domain: image_processing
          multiple: true

    label_name:
      name: Label DOODS Ã  dÃ©tecter
      description: "Exemple : person"
      default: person
      selector:
        text:

    min_confidence:
      name: Confiance minimale (%)
      description: >
        Score DOODS minimum requis (ex: 50)
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"

    notify_service:
      name: Service de notification
      description: >
        Service notify de lâ€™application Companion
        (ex: notify.mobile_app_sm_s928b)
      selector:
        text:

    snapshot_dir:
      name: Dossier des snapshots
      description: >
        Doit Ãªtre sous /config/www pour Ãªtre accessible via /local
      default: /config/www/snapshots/camera
      selector:
        text:

    second_between_photos:
      name: DÃ©lai entre les photos (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 1

mode: parallel
max: 10

###############################################################################
# VARIABLES Dâ€™ENTRÃ‰E
###############################################################################
variables:
  i_label: !input label_name
  i_conf: !input min_confidence
  i_notify: !input notify_service
  i_dir: !input snapshot_dir
  i_delay: !input second_between_photos

###############################################################################
# TRIGGER
# DÃ©clenche uniquement quand DOODS dÃ©tecte au moins un objet (> 0)
###############################################################################
trigger:
  - platform: numeric_state
    entity_id: !input doods_entities
    above: 0

###############################################################################
# CONDITIONS
###############################################################################
condition:
  - condition: template
    alias: "Label DOODS prÃ©sent avec score suffisant"
    value_template: >
      {% set matches = state_attr(trigger.entity_id, 'matches') or {} %}
      {% set label = i_label | lower %}
      {% set threshold = i_conf | float %}
      {{ matches.get(label, [])
         | selectattr('score','>=', threshold)
         | list
         | count > 0 }}

###############################################################################
# ACTIONS
###############################################################################
action:

  # Variables calculÃ©es dynamiquement Ã  partir de l'entitÃ© DOODS
  - variables:
      # Convention attendue :
      # image_processing.doods_camera_xxx â†’ camera.camera_xxx
      camera_entity: >
        {% set eid = trigger.entity_id.replace('image_processing.doods_', '') %}
        {{ 'camera.' ~ eid }}

      camera_name: "{{ camera_entity.split('camera.')[-1] }}"
      ts: "{{ now().strftime('%Y%m%d_%H%M%S') }}"

      file1: "{{ i_dir ~ '/' ~ camera_name ~ '_' ~ ts ~ '_1.jpg' }}"
      file2: "{{ i_dir ~ '/' ~ camera_name ~ '_' ~ ts ~ '_2.jpg' }}"

      # Conversion /config/www â†’ /local (requis par Companion App)
      url1: "{{ '/local' ~ file1.split('/config/www')[-1] }}"
      url2: "{{ '/local' ~ file2.split('/config/www')[-1] }}"

  # ğŸ“¸ Snapshot 1
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ file1 }}"

  # â±ï¸ Pause configurable
  - delay:
      seconds: !input second_between_photos

  # ğŸ“¸ Snapshot 2
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ file2 }}"

  # ğŸ“² Notification 1
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ‘¤ Personne dÃ©tectÃ©e ({{ camera_name }})"
      message: "DÃ©tection DOODS â‰¥ {{ i_conf }} %"
      data:
        image: "{{ url1 }}"
        push:
          sound: default

  # ğŸ“² Notification 2
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ“¸ DeuxiÃ¨me photo ({{ camera_name }})"
      message: "Instant +{{ i_delay }} s"
      data:
        image: "{{ url2 }}"