blueprint:
  name: DOODS â€“ Multi-camÃ©ras â†’ Image latest + 1 photo + 2 notifications (Companion)
  description: >
    Envoie la derniÃ¨re image sauvegardÃ©e par DOODS (latest)
    et un instantanÃ© live de la camÃ©ra en 2 notifications push
    lorsqu'une entitÃ© DOODS dÃ©tecte un label donnÃ© (ex: person).
    Compatible avec la structure DOODS :
    matches: { label: [ { score, box } ] }

  domain: automation

  input:
    doods_entities:
      name: EntitÃ©s DOODS
      description: >
        EntitÃ©s image_processing.doods_* Ã  surveiller
      selector:
        entity:
          domain: image_processing
          multiple: true

    label_name:
      name: Label DOODS Ã  dÃ©tecter
      description: "Exemple : person"
      default: person
      selector:
        text:

    min_confidence:
      name: Confiance minimale (%)
      description: >
        Score DOODS minimum requis (ex: 50)
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"

    notify_service:
      name: Service de notification
      description: >
        Service notify de lâ€™application Companion
        (ex: notify.mobile_app_sm_s928b)
      selector:
        text:

    snapshot_dir:
      name: Dossier des snapshots
      description: >
        Doit Ãªtre sous /config/www pour Ãªtre accessible via /local
      default: /config/www/snapshots/camera
      selector:
        text:

mode: parallel
max: 10

###############################################################################
# VARIABLES Dâ€™ENTRÃ‰E
###############################################################################
variables:
  i_label: !input label_name
  i_conf: !input min_confidence
  i_notify: !input notify_service
  i_dir: !input snapshot_dir

###############################################################################
# TRIGGER
# DÃ©clenche uniquement quand DOODS dÃ©tecte au moins un objet (> 0)
###############################################################################
trigger:
  - platform: numeric_state
    entity_id: !input doods_entities
    above: 0

###############################################################################
# CONDITIONS
###############################################################################
condition:
  - condition: template
    alias: "Label DOODS prÃ©sent avec score suffisant"
    value_template: >
      {% set matches = state_attr(trigger.entity_id, 'matches') or {} %}
      {% set label = i_label | lower %}
      {% set threshold = i_conf | float %}
      {{ matches.get(label, [])
         | selectattr('score','>=', threshold)
         | list
         | count > 0 }}

###############################################################################
# ACTIONS
###############################################################################
action:

  # Variables dynamiques Ã  partir de l'entitÃ© DOODS
  - variables:
      # image_processing.doods_camera_xxx â†’ camera.camera_xxx
      camera_entity: >
        {% set eid = trigger.entity_id.replace('image_processing.doods_', '') %}
        {{ 'camera.' ~ eid }}

      camera_name: "{{ camera_entity.split('camera.')[-1] }}"

      # Chemin de l'image latest sauvegardÃ©e par DOODS (accessible via /local)
      latest_file: "{{ i_dir }}/{{ camera_name }}_latest.jpg"
      latest_url: "{{ '/local' ~ latest_file.split('/config/www')[-1] }}"

      # Nom et chemin pour la photo instantanÃ©e (timestampÃ©)
      ts: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
      snap_file: "{{ i_dir }}/{{ camera_name }}_{{ ts }}.jpg"
      snap_url: "{{ '/local' ~ snap_file.split('/config/www')[-1] }}"

  # ğŸ“¸ Prise de la photo instantanÃ©e
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snap_file }}"

  # ğŸ“² Notification 1 : image latest sauvegardÃ©e par DOODS
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ‘¤ Personne dÃ©tectÃ©e ({{ camera_name }})"
      message: "Image DOODS (latest) - dÃ©tection â‰¥ {{ i_conf }} %"
      data:
        image: "{{ latest_url }}"
        push:
          sound: default

  # ğŸ“² Notification 2 : photo instantanÃ©e fraÃ®che
  - service: "{{ i_notify }}"
    data:
      title: "ğŸ“¸ Photo instantanÃ©e ({{ camera_name }})"
      message: "InstantanÃ© pris Ã  la dÃ©tection"
      data:
        image: "{{ snap_url }}"